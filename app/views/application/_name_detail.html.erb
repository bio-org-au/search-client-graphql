<% search_form ||= params[:search_form] %>

  <% @results.names.each do |name| %>
    <h3 class="name-heading <%= params[:action] %>">
      <% if @client_request.family? && name.family_name != 'na' %>
        [<span title="family name" class="family-name"><%= name.family_name %></span>]
      <% end %>

      <% name_string = name.full_name %>
      <% unless name.name_status_name.blank? %>
        <% name_string += %(, <i class="highlight name-status" title="name status">#{name.name_status_name}</i>) %>
      <% end %>
      <% if @client_request.links? %>
        <%= link_to name_string.html_safe, show_name_path(id: name.id, search_form: search_form), title: "Show name details in a new page" %>
      <% else %>
        <%= name_string.html_safe %>
      <% end %>
    </h3>

      <ul class="name-details plain indent3">
        <% curr_ref_id = -1 %>
        <% curr_page = '' %>
        <% name.usages.each do |usage| %>
          <% unless curr_ref_id == usage.reference_id && 
                    curr_page == usage.page %>
            <%= "</ul>".html_safe unless curr_ref_id == -1 %>
            <% curr_ref_id = usage.reference_id %>
            <% curr_page = usage.page %>
            <% if usage.misapplied? %>
              <li><%= usage.citation_for_misapplied %>
              <ul class="plain indent4">
            <% else %>
              <li><%= usage.full_citation_with_page %>
              <ul class="plain indent4">
            <% end %>
          <% end %>
            <% usage.synonyms.each do |synonym| %>
              <li class="indent"><span class="synonym-type"><%= synonym.label %>:</span>
                <% if @client_request.links? %>
                  <%= link_to synonym.full_name, show_name_path(id: synonym.name_id, search_form: search_form), title: "Show name details in a new page" %>
                <% else %>
                  <%= synonym.full_name %> <%= "#{synonym.name_status_name}" %>
                <% end %>




            <% end %>
            <% if usage.misapplied? %>
              <li>misapplied to:
                <%= usage.misapplied_to_name %>
                by
                <%= usage.misapplied_by_citation %>
                :
                <%= usage.misapplied_on_page %>
            <% end %>
            <% unless usage.notes.nil? %>
              <ul class="plain">
              <% usage.notes.each do |note| %>
                <li>
                <b><%= note.key %>:</b>
                <%= note.value.html_safe %>
              <% end %>
              </ul>
            <% end %>
            <div class="name-detail-entry-separator <%= params[:action] %>"></div>
        <% end %>
        </ul>
      </ul>
  <% end %>
